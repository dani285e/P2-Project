<!DOCTYPE html>
<html lang="da">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Maskine Oversigt</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">Projektstyringssystem</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="/">Projekter</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/employees">Medarbejdere</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/machines">Maskiner</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/bookings">Bookinger</a>
            </li>
          </ul>
          <a id="createMachineBtn" class="btn btn-success ms-lg-2">
            <i class="bi bi-plus-circle"></i> Opret Ny Maskine
          </a>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="text-center mb-4">
        <h1 class="text-primary">Maskine Oversigt</h1>
      </div>
      <div class="card">
        <div id="machine-list" class="card-body">
          <p class="text-muted text-center">Indlæser maskiner...</p>
        </div>
      </div>
    </div>

    <div id="machineModal" class="modal fade" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="modalTitle" class="modal-title">Opret Ny Maskine</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="machineForm" method="post" action="javascript:void(0);">
              <input type="hidden" id="machineId" name="machineId" />
              <div class="mb-3">
                <label for="machineName" class="form-label">Maskine Navn*</label>
                <input type="text" id="machineName" name="machineName" class="form-control" required />
              </div>
              <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" id="cancelBtn" data-bs-dismiss="modal">Annuller</button>
                <button type="submit" class="btn btn-success">Gem</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const machineList = document.getElementById("machine-list");
      const createMachineBtn = document.getElementById("createMachineBtn");
      const machineModal = new bootstrap.Modal(document.getElementById("machineModal"));
      const machineForm = document.getElementById("machineForm");
      const modalTitle = document.getElementById("modalTitle");
      const machineId = document.getElementById("machineId");
      const machineName = document.getElementById("machineName");

      createMachineBtn.addEventListener("click", openCreateModal);
      machineForm.addEventListener("submit", saveMachine);
      document.addEventListener("DOMContentLoaded", loadMachines);

      const API_URL = "/api";

      async function loadMachines() {
        try {
          const response = await fetch(`${API_URL}/machines`);
          const result = await response.json();

          let machines = [];
          if (result.success && Array.isArray(result.data)) {
            machines = result.data;
          } else if (Array.isArray(result)) {
            machines = result;
          } else {
            throw new Error("Uventet dataformat returneret fra API");
          }

          renderMachineList(machines);
        } catch (error) {
          console.error("Fejl ved hentning af maskiner:", error);
          machineList.innerHTML = `<p class="text-danger">Der opstod en fejl ved hentning af maskiner: ${error.message}</p>`;
        }
      }

      function renderMachineList(machines) {
        if (machines.length === 0) {
          machineList.innerHTML = "<p class='text-muted text-center'>Ingen maskiner fundet. Opret en ny maskine for at komme i gang.</p>";
          return;
        }

        let html = `
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Navn</th>
                <th>Status</th>
                <th>Handlinger</th>
              </tr>
            </thead>
            <tbody>
        `;

        machines.forEach((machine) => {
          const statusClass = machine.status === "Ledig" ? "bg-success text-white" : "bg-danger text-white";

          html += `
            <tr>
              <td>${machine.name}</td>
              <td><span class="badge ${statusClass}">${machine.status}</span></td>
              <td>
                <button class="btn btn-warning btn-sm" onclick="editMachine('${machine._id}', '${machine.name}')">Rediger</button>
                <button class="btn btn-danger btn-sm" onclick="deleteMachine('${machine._id}', '${machine.name}')">Slet</button>
              </td>
            </tr>
          `;
        });

        html += `
            </tbody>
          </table>
        `;

        machineList.innerHTML = html;
      }

      function openCreateModal() {
        modalTitle.textContent = "Opret Ny Maskine";
        machineId.value = "";
        machineName.value = "";
        machineModal.show();
      }

      function editMachine(id, name) {
        modalTitle.textContent = "Rediger Maskine";
        machineId.value = id;
        machineName.value = name;
        machineModal.show();
      }

      async function saveMachine(e) {
        e.preventDefault();

        const machineData = {
          name: machineName.value,
        };

        const isEditing = machineId.value !== "";

        try {
          let response;

          if (isEditing) {
            response = await fetch(`${API_URL}/machines/${machineId.value}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(machineData),
            });
          } else {
            response = await fetch(`${API_URL}/machines`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(machineData),
            });
          }

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.message || "Der opstod en fejl");
          }

          machineModal.hide();
          loadMachines();

          const message = isEditing ? "Maskinen er blevet opdateret" : "Ny maskine er blevet oprettet";
          alert(message);
        } catch (error) {
          console.error("Fejl ved gem maskine:", error);
          alert(`Der opstod en fejl: ${error.message}`);
        }
      }

      async function deleteMachine(id, name) {
        const confirm = window.confirm(`Er du sikker på, at du vil slette maskinen \"${name}\"?`);

        if (!confirm) return;

        try {
          const response = await fetch(`${API_URL}/machines/${id}`, {
            method: "DELETE",
          });

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.message || "Der opstod en fejl");
          }

          loadMachines();
          alert("Maskinen er blevet slettet");
        } catch (error) {
          console.error("Fejl ved sletning af maskine:", error);
          alert(`Der opstod en fejl ved sletning: ${error.message}`);
        }
      }

      window.editMachine = editMachine;
      window.deleteMachine = deleteMachine;
    </script>
  </body>
</html>
