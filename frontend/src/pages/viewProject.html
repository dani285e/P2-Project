<!DOCTYPE html>
<html lang="da">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Projekt Detaljer</title>
    <!-- Include Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">Projektstyringssystem</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item"><a class="nav-link" href="/">Projekter</a></li>
            <li class="nav-item"><a class="nav-link" href="/employees">Medarbejdere</a></li>
            <li class="nav-item"><a class="nav-link" href="/machines">Maskiner</a></li>
            <li class="nav-item"><a class="nav-link" href="/bookings">Bookinger</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="text-primary">Projekt Detaljer</h2>
          <a href="/" class="btn btn-secondary">Tilbage til oversigt</a>
        </div>
        <div class="card-body" id="project-details">
          <p class="text-muted">Indlæser projekt...</p>
        </div>
        <div class="d-flex justify-content-end gap-2">
          <button id="btn-edit" class="btn btn-warning">Rediger Projekt</button>
          <button id="btn-delete" class="btn btn-danger">Slet Projekt</button>
        </div>
      </div>
    </div>

    <!-- Include Bootstrap JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
    ></script>
    <script type="module">
      import { getProjectById, deleteProject } from "../js/projectOverview.js";

      document.addEventListener("DOMContentLoaded", async () => {
        // Get project ID from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get("id");

        if (!projectId) {
          alert("Intet projekt-ID angivet!");
          window.location.href = "/";
          return;
        }

        try {
          // Fetch project details
          const project = await getProjectById(projectId);
          renderProjectDetails(project);

          // Set up button event listeners
          document.getElementById("btn-edit").addEventListener("click", () => {
            window.location.href = `/editProject?id=${projectId}`;
          });

          document
            .getElementById("btn-delete")
            .addEventListener("click", async () => {
              try {
                await deleteProject(projectId);
                window.location.href = "/";
              } catch (error) {
                alert(`Fejl ved sletning af projekt: ${error.message}`);
              }
            });
        } catch (error) {
          alert(`Fejl ved indlæsning af projekt: ${error.message}`);
          window.location.href = "/";
        }
      });

      function renderProjectDetails(project) {
        const projectDetailsElement =
          document.getElementById("project-details");

        // Format dates
        const startDate = new Date(project.startDate).toLocaleDateString(
          "da-DK"
        );
        const deadline = new Date(project.deadline).toLocaleDateString("da-DK");

        let inspectionsHtml = "";

        if (project.isClassProject && project.inspections) {
          inspectionsHtml = `
          <dt>Inspektioner</dt>
          <dd>
            <ul class="list-group">
              ${renderInspection(
                "1. Inspektion",
                project.inspections.firstInspection
              )}
              ${renderInspection("WPS/WPQR", project.inspections.wpsWpqr)}
              ${renderInspection("NDT", project.inspections.ndt)}
              ${renderInspection(
                "Final Inspection",
                project.inspections.finalInspection
              )}
              ${renderInspection("Report", project.inspections.report)}
            </ul>
          </dd>
        `;
        }

        projectDetailsElement.innerHTML = `
        <h2 class="text-primary">${project.name}</h2>
        
        <dl class="row">
          <dt class="col-sm-4">Projekt ID</dt>
          <dd class="col-sm-8">${project.projectID}</dd>
          
          <dt class="col-sm-4">Kunde</dt>
          <dd class="col-sm-8">${project.customer}</dd>
          
          <dt class="col-sm-4">Beskrivelse</dt>
          <dd class="col-sm-8">${project.description || "Ingen beskrivelse"}</dd>
          
          <dt class="col-sm-4">Startdato</dt>
          <dd class="col-sm-8">${startDate}</dd>
          
          <dt class="col-sm-4">Deadline</dt>
          <dd class="col-sm-8">${deadline}</dd>
          
          <dt class="col-sm-4">Pris</dt>
          <dd class="col-sm-8">${project.price.toLocaleString("da-DK")} kr.</dd>
          
          <dt class="col-sm-4">Klasseprojekt</dt>
          <dd class="col-sm-8">${project.isClassProject ? "Ja" : "Nej"}</dd>
          
          ${inspectionsHtml}
        </dl>
      `;
      }

      function renderInspection(name, inspection) {
        if (!inspection || !inspection.selected) {
          return "";
        }

        const inspectionDate = inspection.date
          ? new Date(inspection.date).toLocaleDateString("da-DK")
          : "Ingen dato angivet";

        return `
        <li class="list-group-item">
          <strong>${name}:</strong> ${inspectionDate}
        </li>
      `;
      }
    </script>
  </body>
</html>
